---
Date: 2024-05-28T09:11:00
Summary: CMD & Powershell
---

# Windows Command Line
---
#HTB #prerequisites #CDSA #windows #windows_terminal

Table of contents >>> [[Hack The Box]]
- [Windows Command Line](#Windows%20Command%20Line)
- [Introduction](#Introduction)
- [Command Prompt Basics](#Command%20Prompt%20Basics)
- [Getting Help](#Getting%20Help)
- [System Navigation](#System%20Navigation)
- [Working with Directories and Files](#Working%20with%20Directories%20and%20Files)
- [Gathering System Information](#Gathering%20System%20Information)
- [Finding Files and Directories](#Finding%20Files%20and%20Directories)
- [Environment Variables](#Environment%20Variables)
- [Managing Services](#Managing%20Services)
- [Working With Scheduled Tasks](#Working%20With%20Scheduled%20Tasks)
- [CMD vs PowerShell](#CMD%20vs%20PowerShell)
- [All About Cmdlets and Modules](#All%20About%20Cmdlets%20and%20Modules)
- [User and Group Management](#User%20and%20Group%20Management)

---

There are two main built-in tools in windows and these are CMD and PowerShell.
- You can run CMD commands on PowerShell
- You can run PowerShell commands on CMD but you have to preface the command with PowerShell get-alias

| **PowerShell**                                                             | *Command Prompt*                                      |
| -------------------------------------------------------------------------- | ----------------------------------------------------- |
| Introduced in 2006                                                         | Introduced in 1981                                    |
| Can run both batch commands and PowerShell cmdlets                         | Can only run batch commands                           |
| Supports the use of command aliases                                        | Does not support command aliases                      |
| Cmdlet output can be passed to other cmdlets                               | Command output cannot be passed to other commands     |
| All output is in the form of an object                                     | Output of commands is text                            |
| Able to execute a sequence of cmdlets in a script                          | A command must finish before the next command can run |
| Has an Integrated Scripting Environment (ISE)                              | Does not have an ISE                                  |
| Can access programming libraries because it is built on the .NET framework | Cannot access these libraries                         |
| Can be run on Linux systems                                                | Can only be run on Windows systems                    |
# Command Prompt Basics
---
CMD allows to input commands that are directly interpreted and the executed by the OS. A single command can change user's password or check the status of NICs.

Local Access:
- Using the Windows key + `r` to bring up the run prompt, and then typing in `cmd`. OR
- Accessing the executable from the drive path `C:\Windows\System32\cmd.exe`.

Remote Access:
- Secure Shell (`SSH`), `PsExec`, `WinRM`, `RDP`, or other protocols as needed

# Getting Help
---
```cmd-session
help time
```

Some commands use `/?` instead of help command #command 

```cmd
ipconfig /?
```

Cheat Sheet - [ss64](https://ss64.com/nt/)

#### Command history
To display commands history: #command 
```cmd-session
donkey /history
```
`Donkey` is an MS-DOS utility that keeps a history of commands issued and allows them to be referenced again.

| **Key/Command** | **Description**                                                                                                            |
| :-------------: | -------------------------------------------------------------------------------------------------------------------------- |
| doskey /history | doskey /history will print the session's command history to the terminal or output it to a file when specified.            |
|     page up     | Places the first command in our session history to the prompt.                                                             |
|    page down    | Places the last command in history to the prompt.                                                                          |
|        ⇧        | Allows us to scroll up through our command history to view previously run commands.                                        |
|        ⇩        | Allows us to scroll down to our most recent commands run.                                                                  |
|        ⇨        | Types the previous command to prompt one character at a time.                                                              |
|        ⇦        | N/A                                                                                                                        |
|       F3        | Will retype the entire previous entry to our prompt.                                                                       |
|       F5        | Pressing F5 multiple times will allow you to cycle through previous commands.                                              |
|       F7        | Opens an interactive list of previous commands.                                                                            |
|       F9        | Enters a command to our prompt based on the number specified. The number corresponds to the commands place in our history. |
`ctrl+c` is how we interrupt a program effectively killing it


# System Navigation
---
List Directories #command 
```cmd-session
dir
```

Change directory #command 
```cmd-session
cd 
```

There is difference between absolute path and relative:
```cmd-session
cd C:\Users\htb\Pictures	                    and/or        

cd .\Pictures
```

To list all folder and files #command 
```cmd-session
tree /F
```
#### Interesting Directories
| Name:               | Location:                            | Description:                                                                                                                                                                                                                                                                     |
| ------------------- | ------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| %SYSTEMROOT%\Temp   | `C:\Windows\Temp`                    | Global directory containing temporary system files accessible to all users on the system. All users, regardless of authority, are provided full read, write, and execute permissions in this directory. Useful for dropping files as a low-privilege user on the system.         |
| %TEMP%              | `C:\Users\<user>\AppData\Local\Temp` | Local directory containing a user's temporary files accessible only to the user account that it is attached to. Provides full ownership to the user that owns this folder. Useful when the attacker gains control of a local/domain joined user account.                         |
| %PUBLIC%            | `C:\Users\Public`                    | Publicly accessible directory allowing any interactive logon account full access to read, write, modify, execute, etc., files and subfolders within the directory. Alternative to the global Windows Temp Directory as it's less likely to be monitored for suspicious activity. |
| %ProgramFiles%      | `C:\Program Files`                   | folder containing all 64-bit applications installed on the system. Useful for seeing what kind of applications are installed on the target system.                                                                                                                               |
| %ProgramFiles(x86)% | `C:\Program Files (x86)`             | Folder containing all 32-bit applications installed on the system. Useful for seeing what kind of applications are installed on the target system.                                                                                                                               |
# Working with Directories and Files
---
How to create new directory #command 
```cmd-session
md new-directory
```
How to remove directory #command 
```cmd-session
rd new-directory

rd /S new-directory
```

Move directory #command 
```cmd-session
move example C:\Users\htb\Documents\example
```

Copy directories #command 
```cmd-session
xcopy C:\Users\htb\Documents\example C:\Users\htb\Desktop\ /E
```
/E means to copy any files and subfolders and to include empty subfolder

Robocopy #command 
```cmd-session
robocopy C:\Users\htb\Desktop C:\Users\htb\Documents\
```
It can move files over the network, move them between drives or just simply move files locally retaining the file data and attributes to include timestamps , ownership, ACLs any files set like hidden or read-only.

#### Robocopy
As a user to use `Robocopy` we need to have `SeBackupPrivilege` and `auditing privilege` attributes otherwise the back up of files will fail

```cmd-session
C:\Users\htb\Desktop> robocopy /E /B /L C:\Users\htb\Desktop\example C:\Users\htb\Documents\Backup\

-------------------------------------------------------------------------------
   ROBOCOPY     ::     Robust File Copy for Windows                    
-------------------------------------------------------------------------------

  Started : Monday, June 21, 2021 10:03:56 PM
   Source : C:\Users\htb\Desktop\example\
     Dest : C:\Users\htb\Documents\Backup\

    Files : *.*

  Options : *.* /L /S /E /DCOPY:DA /COPY:DAT /B /R:1000000 /W:30

------------------------------------------------------------------------------

ERROR : You do not have the Backup and Restore Files user rights.
*****  You need these to perform Backup copies (/B or /ZB).

ERROR : Robocopy ran out of memory, exiting.
ERROR : Invalid Parameter #%d : "%s"

ERROR : Invalid Job File, Line #%d :"%s"


  Started : %s %s

   Source %c

     Dest %c
       Simple Usage :: ROBOCOPY source destination /MIR

             source :: Source Directory (drive:\path or \\server\share\path).
        destination :: Destination Dir  (drive:\path or \\server\share\path).
               /MIR :: Mirror a complete directory tree.

    For more usage information run ROBOCOPY /?


****  /MIR can DELETE files as well as copy them !
```

- Our permissions are insufficient.
- Using the /MIR switch will:
    - Complete the task by mirroring the source to the destination.
    - Mark files as a system backup and hide them from view.
- To clear these attributes, add the /A-
    
    switch to the command.
- Be cautious with the /MIR switch:
    - It will delete any files in the destination that are not in the source.
    - Ensure the destination folder is empty before copying.
- The /L switch was used to:
    - Show the potential result without executing the command.
- Let's try it below.

#### Files
To read  txt files #command 
```cmd-session
 more secrets.txt
```
`/S` will make the command print one line gap between text

Using pipes #command 
```cmd-session
ipconfig /all | more
```

To display content of text files #command 
```cmd-session
type bio.txt
```

To write to another files using the output #command 
```cmd-session
type passwords.txt >> secrets.txt
```

#### Create and Modify and Append Files

Echo to create and append files #command 
```cmd-session
echo Check out this text > demo.txt
```

Fsutil to create a file #command 
```cmd-session
fsutil file createNew for-sure.txt 222
```

To change file name #command 
```cmd-session
ren demo.txt superdemo.txt
```
Output to a file: #command 
```cmd-session
ipconfig /all > details.txt
```
Append to a file #command 
```cmd-session
C:\Users\htb\Documents> echo a b c d e > test.txt

C:\Users\htb\Documents>type test.txt
a b c d e

C:\Users\htb\Documents>echo f g h i j k see how this works now? >> test.txt

C:\Users\htb\Documents>type test.txt
a b c d e
f g h i j k see how this works now?
```

Pass a text file to a command #command 
```cmd-session
C:\Users\htb\Documents>find /i "see" < test.txt

f g h i j k see how this works now?
```
These were fairly simple commands, but remember that we can use `<` like this to search for keywords or strings in large text files, sort for unique items, and much more.

Pipe to another command #command 
```cmd-session
ipconfig /all | find /i "IPV4"
```

Run A Then B #command 
```cmd-session
ping 8.8.8.8 & type test.txt
```

we can use && if A succeeds then run B

Remove files #command 
```cmd-session
erase file-3 file-5
```

View Files with Read-only #command 
```cmd-session
dir /A:R
```

Delete any file with read-only #command 
```cmd-session
del /A:R *
```

View hidden files #command 
```cmd-session
dir /A:H
```

Copy and move files #command 
```cmd-session
copy calc.exe C:\Users\student\Downloads\copied-calc.exe /V
```

# Gathering System Information
---
Before we start looking through the system we need to have an idea of what we want to look into and what kind of information we can expect to get:
![[InformationTypesChart_Updated.webp]]

| Type                         | Description                                                                                                                                                                                                                                                                                                                                              |
| ---------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `General System Information` | Contains information about the overall target system. Target system information includes but is not limited to the `hostname` of the machine, OS-specific details (`name`, `version`, `configuration`, etc.), and `installed hotfixes/patches` for the system.                                                                                           |
| `Networking Information`     | Contains networking and connection information for the target system and system(s) to which the target is connected over the network. Examples of networking information include but are not limited to the following: `host IP address`, `available network interfaces`, `accessible subnets`, `DNS server(s)`, `known hosts`, and `network resources`. |
| `Basic Domain Information`   | Contains Active Directory information regarding the domain to which the target system is connected.                                                                                                                                                                                                                                                      |
| `User Information`           | Contains information regarding local users and groups on the target system. This can typically be expanded to contain anything accessible to these accounts, such as `environment variables`, `currently running tasks`, `scheduled tasks`, and `known services`.                                                                                        |
#### Getting system info
Getting general system info #command 
```
systeminfo
os
ver
```

#### Getting network info
To find network information #command 
```cmd-session
ipconfig
```

What devices it communicates with #command 
```cmd-session
arp /a
```
It's being used to map the network and understand what devices it was connected to or is connected to

#### Gathering user info
User name #command 
```cmd-session
whoami
```

To find out about the privileges for the account #command 
```cmd-session
whoami /priv
```

To find out about groups #command 
```cmd-session
whoami /groups
```

To display information of all users on a host #command 
```cmd-session
net user
```

To display all groups available on the host #command 
```cmd-session
net localgroup
```

To find shared resources #command 
```cmd-session
net share  
```

TO find out about the environment #command 
```cmd-session
net view
```


# Finding Files and Directories
---
#### Where
Looking for files using `where` #command 
```cmd-session
where calc.exe
```
The command will work depending whether the folder we looking through is in our environment variable path.
Using `/R` and a full path directory can help us find the file
```
where /R C:\Users\DaVinci\ windhawk_setup.exe
```
We can also look for things like file types  by running this command
```
where /R C:\Users\DaVinci\ *.exe
```

#### Find
Find is used to search for text strings or their absence within a file or files.
Looking for file using `find` #command 
```cmd-session
find "password" "C:\Users\student\not-passwords.txt" 
```
Parameter `/V` can be used as `Not` clause. It will only show us the lines that do not contain specific string. We can use `/N` to display line numbers and `/I` to ignore sensitivity.
```cmd-session
find /N /I /V "IP Address" example.txt  
```
There is also `findstr` which searches for patterns. It's like grep:
```cmd-session
findstr
```

#### Compare
Comp will each byte to find differences and then display them. Use `/A` modifier to see differences in ASCII format. Use `/L` to display line numbers.
To run `comp` #command 
```cmd-session
comp .\file-1.md .\file-2.md
```
Comparing different files
```powershell-session
PS C:\htb> echo a > .\file-1.md
PS C:\Users\MTanaka\Desktop> echo a > .\file-2.md
PS C:\Users\MTanaka\Desktop> comp .\file-1.md .\file-2.md /A
Comparing .\file-1.md and .\file-2.md...
Files compare OK
<SNIP>
PS C:\Users\MTanaka\Desktop> echo b > .\file-2.md
PS C:\Users\MTanaka\Desktop> comp .\file-1.md .\file-2.md /A
Comparing .\file-1.md and .\file-2.md...
Compare error at OFFSET 2
file1 = a
file2 = b  
```

FC will show you which lines are different
To run `fc` and compare lines #command 
```powershell-session
PS C:\htb> echo a > .\file-1.md
PS C:\Users\MTanaka\Desktop> echo a > .\file-2.md
PS C:\Users\MTanaka\Desktop> comp .\file-1.md .\file-2.md /A
Comparing .\file-1.md and .\file-2.md...
Files compare OK
<SNIP>
PS C:\Users\MTanaka\Desktop> echo b > .\file-2.md
PS C:\Users\MTanaka\Desktop> comp .\file-1.md .\file-2.md /A
Comparing .\file-1.md and .\file-2.md...
Compare error at OFFSET 2
file1 = a
file2 = b  
```

#### Sorting
We can use sort to receive input from console, pipeline or a file and sort it and send the results to the console or file or another command. It's being used with | < > 
To `sort` files #command 
```cmd-session
C:\Users\student\Desktop> type .\file-1.md
a
b
d
h
w
a
q
h
g

C:\Users\MTanaka\Desktop> sort.exe .\file-1.md /O .\sort-1.md
C:\Users\MTanaka\Desktop> type .\sort-1.md

a
a
b
d
g
h
h
q
w
```
Above, we can see using `sort` on the file `file-1.md` and then sending the result with the `/O` modifier to the file sort-1.md, we took our list of letters, sorted them in alphabetical order,
To sort only unique entries we use `/unique`
```cmd-session
C:\htb> type .\sort-1.md

a
a
b
d
g
h
h
q
w

PS C:\Users\MTanaka\Desktop> sort.exe .\sort-1.md /unique

a
b
d
g
h
q
w  
```

# Environment Variables
---
  Environment Variables are settings applied globally to the host. On Windows they are not case sensitive. Variables usually look like this: `%SUPER_IMPORTANT_VARIABLE%`.
  There is also variable SCOPE which devise variable into:
  - **Global scope** where it can be access and referenced the data stored inside the variable from anywhere within a program.
  - **Local scope** - Local variables can only be accessed within the function or block of code where they are defined. This means that these variables are not visible or usable outside of that specific function or block.
Global variable:
```cmd-session
echo %WINDIR%
C:\Windows
```

| Scope              | Description                                                                                                                                                                                                                                                                                                                                                                                       | Permissions Required to Access                                    | Registry Location                                                                 |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------- | --------------------------------------------------------------------------------- |
| `System (Machine)` | The System scope contains environment variables defined by the Operating System (OS) and are accessible globally by all users and accounts that log on to the system. The OS requires these variables to function properly and are loaded upon runtime.                                                                                                                                           | Local Administrator or Domain Administrator                       | `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Environment` |
| `User`             | The User scope contains environment variables defined by the currently active user and are only accessible to them, not other users who can log on to the same system.                                                                                                                                                                                                                            | Current Active User, Local Administrator, or Domain Administrator | `HKEY_CURRENT_USER\Environment`                                                   |
| `Process`          | The Process scope contains environment variables that are defined and accessible in the context of the currently running process. Due to their transient nature, their lifetime only lasts for the currently running process in which they were initially defined. They also inherit variables from the System/User Scopes and the parent process that spawns it (only if it is a child process). | Current Child Process, Parent Process, or Current Active User     | `None (Stored in Process Memory)`                                                 |

Display all variables with `set and echo` #command 
Set
```
set 
%SYSTEMROOT%
```
Echo:
```
echo %PATH%
```

#### set vs setx
*set* makes the changes that are only *applied to current session* and will be removed once session is closed. *setx permanently* changes those variables.

Creating new variable or change #command 
```cmd-session
set DCIP=172.16.5.2
```

to verify this variable we can use `echo`
```cmd-session
echo %DCIP%
```

permanently create new variable or change:
```cmd-session
setx DCIP 172.16.5.2
```

remove variable #command 
```cmd-session
setx DCIP ""
```

#### Important Environment Variables
|Variable Name|Description|
|---|---|
|`%PATH%`|Specifies a set of directories(locations) where executable programs are located.|
|`%OS%`|The current operating system on the user's workstation.|
|`%SYSTEMROOT%`|Expands to `C:\Windows`. A system-defined read-only variable containing the Windows system folder. Anything Windows considers important to its core functionality is found here, including important data, core system binaries, and configuration files.|
|`%LOGONSERVER%`|Provides us with the login server for the currently active user followed by the machine's hostname. We can use this information to know if a machine is joined to a domain or workgroup.|
|`%USERPROFILE%`|Provides us with the location of the currently active user's home directory. Expands to `C:\Users\{username}`.|
|`%ProgramFiles%`|Equivalent of `C:\Program Files`. This location is where all the programs are installed on an `x64` based system.|
|`%ProgramFiles(x86)%`|Equivalent of `C:\Program Files (x86)`. This location is where all 32-bit programs running under `WOW64` are installed. Note that this variable is only accessible on a 64-bit host. It can be used to indicate what kind of host we are interacting with. (`x86` vs. `x64` architecture)|
[More info][https://ss64.com/nt/syntax-variables.html] -Using this information as a guide, we can start gathering any required information from these variables to help us learn about our host and its target environment inside and out.

# Managing Services
---
SC is a windows utility that allows us to query modify and manage host services locally and over the network.

To list all the services #coommand
```cmd-session
sc query type= service
```

To find if windows defender works #command 
```cmd-session
sc query windefend 
```

To stop service
```cmd-session
sc stop windefend
```

To start service
```
sc start windefend
```
Fun fact some services can only be stopped by `SYSTEM` machine account therefore even admins won't be able to do this.

Stopping Spooler Service
```cmd-session
sc stop windefend
```

#### Disabling Windows Updates Using SC
To configure services, we must use the [config](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/sc-config) parameter in `sc`. This will allow us to modify the values of existing services, regardless if they are currently running or not. All changes made with this command are reflected in the Windows registry as well as the database for Service Control Manager (`SCM`). Remember that all changes to existing services will only fully update after restarting the service.

|Service|Display Name|
|---|---|
|`wuauserv`|Windows Update Service|
|`bits`|Background Intelligent Transfer Service|
Disabling start up services #command 
```cmd-session
sc config bits start= disabled
```

List of current running services #command 
```cmd-session
tasklist /svc
```
Another command that does the smae
```cmd-session
net start
```
another command that gives full list of all services and their status #command 
```cmd-session
wmic service list brief
```

# Working With Scheduled Tasks
---
#### Triggers That Can Kick Off a Scheduled Task
- When a specific system event occurs.
- At a specific time.
- At a specific time on a daily schedule.
- At a specific time on a weekly schedule.
- At a specific time on a monthly schedule.
- At a specific time on a monthly day-of-week schedule.
- When the computer enters an idle state.
- When the task is registered.
- When the system is booted.
- When a user logs on.
- When a Terminal Server session changes state.
#### Query Syntax

|**Action**|**Parameter**|**Description**|
|---|---|---|
|`Query`||Performs a local or remote host search to determine what scheduled tasks exist. Due to permissions, not all tasks may be seen by a normal user.|
||/fo|Sets formatting options. We can specify to show results in the `Table, List, or CSV` output.|
||/v|Sets verbosity to on, displaying the `advanced properties` set in displayed tasks when used with the List or CSV output parameter.|
||/nh|Simplifies the output using the Table or CSV output format. This switch `removes` the `column headers`.|
||/s|Sets the DNS name or IP address of the host we want to connect to. `Localhost` is the `default` specified. If `/s` is utilized, we are connecting to a remote host and must format it as "\\host".|
||/u|This switch will tell schtasks to run the following command with the `permission set` of the `user` specified.|
||/p|Sets the `password` in use for command execution when we specify a user to run the task. Users must be members of the Administrator's group on the host (or in the domain). The `u` and `p` values are only valid when used with the `s` parameter.|
To view already scheduled tasks #command 
```cmd-session
SCHTASKS /Query /V /FO list
```
#### Create Syntax

|**Action**|**Parameter**|**Description**|
|---|---|---|
|`Create`||Schedules a task to run.|
||/sc|Sets the schedule type. It can be by the minute, hourly, weekly, and much more. Be sure to check the options parameters.|
||/tn|Sets the name for the task we are building. Each task must have a unique name.|
||/tr|Sets the trigger and task that should be run. This can be an executable, script, or batch file.|
||/s|Specify the host to run on, much like in Query.|
||/u|Specifies the local user or domain user to utilize|
||/p|Sets the Password of the user-specified.|
||/mo|Allows us to set a modifier to run within our set schedule. For example, every 5 hours every other day.|
||/rl|Allows us to limit the privileges of the task. Options here are `limited` access and `Highest`. Limited is the default value.|
||/z|Will set the task to be deleted after completion of its actions.|
new task creation #command 
```cmd-session
schtasks /create /sc ONSTART /tn "My Secret Task" /tr "C:\Users\Victim\AppData\Local\ncat.exe 172.16.1.100 8100"
```

#### Change the Properties of a Scheduled Task

|**Action**|**Parameter**|**Description**|
|---|---|---|
|-----|-----|-----|
|`Change`||Allows for modifying existing scheduled tasks.|
||/tn|Designates the task to change|
||/tr|Modifies the program or action that the task runs.|
||/ENABLE|Change the state of the task to Enabled.|
||/DISABLE|Change the state of the task to Disabled.|
How to change task #command 
```cmd-session
schtasks /change /tn "My Secret Task" /ru administrator /rp "P@ssw0rd"
```

#### Delete Syntax

|**Action**|**Parameter**|**Description**|
|---|---|---|
|`Delete`||Remove a task from the schedule|
||/tn|Identifies the task to delete.|
||/s|Specifies the name or IP address to delete the task from.|
||/u|Specifies the user to run the task as.|
||/p|Specifies the password to run the task as.|
||/f|Stops the confirmation warning.|T
To delete Tasks #command 
```cmd-session
schtasks /delete  /tn "My Secret Task" 
```
 

# CMD vs PowerShell
---

|**Feature**|**CMD**|**PowerShell**|
|---|---|---|
|Language|Batch and basic CMD commands only.|PowerShell can interpret Batch, CMD, PS cmdlets, and aliases.|
|Command utilization|The output from one command cannot be passed into another directly.|The output from one command can be passed into another directly.|
|Command Output|Text only|PowerShell outputs in object formatting.|
|Parallel Execution|CMD must finish one command before running another.|PowerShell can multi-thread commands to run in parallel.|
PowerShell has been built to be extensible and is also a scripting language. It's using the .NET framwork

Things that can be done on `PowerShell`:
- Provisioning servers and installing server roles
- Creating Active Directory user accounts for new employees
- Managing Active Directory group permissions
- Disabling and deleting Active Directory user accounts
- Managing file share permissions
- Interacting with [Azure](https://azure.microsoft.com/en-us/) AD and Azure VMs
- Creating, deleting, and monitoring directories & files
- Gathering information about workstations and servers
- Setting up Microsoft Exchange email inboxes for users (in the cloud &/or on-premises)
![[LaunchingPowerShellfromCMD.gif]]

#### Basic command  & Get-Help
Pressing `CRTL + Spacebar` Auto completes
Updating Help files for all tools to to learn tools better #command 
```powershell-session
Update-Help
```


To find where we are #command 
```
Get-Location
```

To list all directories #command 
```powershell-session
Get-ChildItem 
```

To change directory #command 
```powershell-session
Set-Location .\Documents\
```
Full path
```powershell
Set-Location C:\Users\DLarusso\Documents  
```

Display contents of a file #command 
```powershell-session
Get-Content Readme.md  
```

To remind us of other commands #command 
```powershell-session
Get-Command
```
To specify which get-command we are looking for:
```powershell-session
Get-Command -verb get
```
All options for windows:
```powershell-session
Get-Command -noun windows*  
```

History of commands #command 
```powershell-session
Get-History
```

With `PSReadLine`, however, that is not the case. `PSReadLine` stores everything in a file called `$($host.Name)_history.txt` located at `$env:APPDATA\Microsoft\Windows\PowerShell\PSReadLine`.

Viewing PSReadLineHistory
```powershell-session
get-content C:\Users\DLarusso\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```

#### Hotkeys

| **HotKey**         | **Description**                                                                                                                                     |
| ------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------- |
| `CTRL+R`           | It makes for a searchable history. We can start typing after, and it will show us results that match previous commands.                             |
| `CTRL+L`           | Quick screen clear.                                                                                                                                 |
| `CTRL+ALT+Shift+?` | This will print the entire list of keyboard shortcuts PowerShell will recognize.                                                                    |
| `Escape`           | When typing into the CLI, if you wish to clear the entire line, instead of holding backspace, you can just hit `escape`, which will erase the line. |
| `↑`                | Scroll up through our previous history.                                                                                                             |
| `↓`                | Scroll down through our previous history.                                                                                                           |
| `F7`               | Brings up a TUI with a scrollable interactive history from our session.                                                                             |
How to change alias #command 
```powershell-session
PS C:\Windows\system32> Set-Alias -Name gh -Value Get-Help
```

#### Helpful Aliases

|**Alias**|**Description**|
|---|---|
|`pwd`|gl can also be used. This alias can be used in place of Get-Location.|
|`ls`|dir and gci can also be used in place of ls. This is an alias for Get-ChildItem.|
|`cd`|sl and chdir can be used in place of cd. This is an alias for Set-Location.|
|`cat`|type and gc can also be used. This is an alias for Get-Content.|
|`clear`|Can be used in place of Clear-Host.|
|`curl`|Curl is an alias for Invoke-WebRequest, which can be used to download files. wget can also be used.|
|`fl and ft`|These aliases can be used to format output into list and table outputs.|
|`man`|Can be used in place of help.|
# All About Cmdlets and Modules
---
#### Cmdlet
Cmdlet is a single-feature command that miniplates objects in PowerShell. They're written in C# or another language. Made of verb and Noun.

#### PowerShell modules
PowerShell code that is made of: cmdlets, script files, functions, assemblies, related resources.

```powershell-session
Get-ChildItem $PSScriptRoot | ? { $_.PSIsContainer -and !('Tests','docs' -contains $_.Name) } | % { Import-Module $_.FullName -DisableNameChecking }
```
The Get-ChildItem cmdlet gets the items in the current directory (represented by the $PSScriptRoot automatic variable), and the Where-Object cmdlet (aliased as the "?" character) filters those down to only the items that are folders and do not have the names "Tests" or "docs". Finally, the ForEach-Object cmdlet (aliased as the "%" character) executes the Import-Module cmdlet against each of those remaining items, passing the DisableNameChecking parameter to prevent errors if the module contains cmdlets or functions with the same names as cmdlets or functions in the current session.


#### Using PowerShell Modules
To find out what modules are loaded #command 
```powershell-session
Get-Module 
```
List-available will show all installed modules but not installed
```powershell-session
Get-Module -ListAvailable 
```
To run the module run this:
```powershell-session
Import-Module
```

#### Execution Policy
It is a tool given by Microsoft to IT admins a tool to set parameters and safe guards for themselves but it is not a security control. Usually what it means is that user won't be able to run some scripts.
To change execution policy (no restrictions) #command 
```powershell-session
Set-ExecutionPolicy undefined 
```

**Note: As a sysadmin, these kinds of changes are common and should always be reverted once we are done with work. As a pentester, us making a change like this and not reverting it could indicate to a defender that the host has been compromised. Be sure to check that we clean up after our actions. Another way we can bypass the execution policy and not leave a persistent change is to change it at the process level using -scope.**

```powershell-session
 Set-ExecutionPolicy -scope Process 
 Get-ExecutionPolicy -list
```

Modules can be installed from two websites:
- [GitHub](https://github.com/)
- [PowerShell Gallery](https://www.powershellgallery.com/)



To install modules from PowerShellGet Admin Tools #command 
Get the command
```powershell-session
Get-Command -Module PowerShellGet 
```
install tools
```powershell-session
Find-Module -Name AdminToolbox | Install-module
```

- [AdminToolbox](https://www.powershellgallery.com/packages/AdminToolbox/11.0.8): AdminToolbox is a collection of helpful modules that allow system administrators to perform any number of actions dealing with things like Active Directory, Exchange, Network management, file and storage issues, and more.
    
- [ActiveDirectory](https://learn.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps): This module is a collection of local and remote administration tools for all things Active Directory. We can manage users, groups, permissions, and much more with it.
    
- [Empire / Situational Awareness](https://github.com/BC-SECURITY/Empire/tree/master/empire/server/data/module_source/situational_awareness): Is a collection of PowerShell modules and scripts that can provide us with situational awareness on a host and the domain they are apart of. This project is being maintained by [BC Security](https://github.com/BC-SECURITY) as a part of their Empire Framework.
    
- [Inveigh](https://github.com/Kevin-Robertson/Inveigh): Inveigh is a tool built to perform network spoofing and Man-in-the-middle attacks.
    
- [BloodHound / SharpHound](https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors): Bloodhound/Sharphound allows us to visually map out an Active Directory Environment using graphical analysis tools and data collectors written in C# and PowerShell.

# User and Group Management
---
Different types of user accounts:
- Service Accounts
- Built-in accounts
- Local users
-  Domain users

#### Built-In Accounts

| **Account**           | **Description**                                                                                                                                                  |
| --------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Administrator`       | This account is used to accomplish administrative tasks on the local host.                                                                                       |
| `Default Account`     | The default account is used by the system for running multi-user auth apps like the Xbox utility.                                                                |
| `Guest Account`       | This account is a limited rights account that allows users without a normal user account to access the host. It is disabled by default and should stay that way. |
| `WDAGUtility Account` | This account is in place for the Defender Application Guard, which can sandbox application sessions.                                                             |
#### Brief Intro to Active Directory

In a nutshell, `Active Directory` (AD) is a directory service for Windows environments that provides a central point of management for `users`, computers, `groups`, network devices, `file shares`, group policies, `devices`, and trusts with other organizations. Think of it as the gatekeeper for an enterprise environment. Anyone who is a part of the domain can access resources freely, while anyone who is not is denied access to those same resources or, at a minimum, stuck waiting in the visitors center.

Within this section, we care about AD in the context of users and groups. We can administer them from PowerShell on `any domain joined host` utilizing the `ActiveDirectory` Module. Taking a deep dive into Active Directory would take more than one section, so we will not try here. To learn more about AD, you should check out the [Introduction to Active Directory module](https://academy.hackthebox.com/module/details/74).


**Local vs Domain** - Domain users can login from domain similar to that of network in university. Local accounts are accounts that can be accessed on system where local user has been created and they have access to this single host..

**User groups** - Groups are a way to sort users accounts logically and in doing so provide granular permission and access to resources without having to manage each user manually.

To get local groups on host
```powershell-session
get-localgroup
```

To get local users
```powershell-session
Get-LocalUser 
```

Creating a new user #command 
```powershell-session
New-LocalUser -Name "JLawrence" -NoPassword
```

Modify a user #command 
```powershell-session
$Password = Read-Host -AsSecureString
```

Adding users to a group
```powershell-session
Add-LocalGroupMember -Group "Remote Desktop Users" -Member "JLawrence"
```

```powershell-session
 Get-LocalGroupMember -Name "Remote Desktop Users" 
```

#### Managing Domaiin Users and Gorups
Installing Remote System Administration Tools #command 
```powershell-session
Get-WindowsCapability -Name RSAT* -Online | Add-WindowsCapability -Online
```

Finding the AD #command 
```powershell-session
Get-Module -Name ActiveDirectory -ListAvailable 
```
All users withing the directory
```powershell-session
Get-ADUser -Filter *
```
Specific User
```powershell-session
 Get-ADUser -Identity TSilver
```
- `Object Class`: which specifies if the object is a user, computer, or another type of object.
- `DistinguishedName`: Specifies the object's relative path within the AD schema.
- `Enabled`: Tells us if the user is active and can log in.
- `SamAccountName`: The representation of the username used to log into the ActiveDirectory hosts.
- `ObjectGUID`: Is the unique identifier of the user object.

Searching users by attribute #command 
```powershell-session
Get-ADUser -Filter {EmailAddress -like '*greenhorn.corp'}
```

Adding new ADUser #command 
```powershell-session
New-ADUser -Name "MTanaka" -Surname "Tanaka" -GivenName "Mori" -Office "Security" -OtherAttributes @{'title'="Sensei";'mail'="MTanaka@greenhorn.corp"} -Accountpassword (Read-Host -AsSecureString "AccountPassword") -Enabled $true 
```
Command break down:
- `New-ADUser -Name "MTanaka"` : We issue the `New-ADUser` command and set the user's SamAccountName to `MTanaka`.
- `-Surname "Tanaka" -GivenName "Mori"`: This portion sets our user's `Lastname` and `Firstname`.
- `-Office "Security"`: Sets the extended property of `Office` to `Security`.
- `-OtherAttributes @{'title'="Sensei";'mail'="MTanaka@greenhorn.corp"}`: Here we set other extended attributes such as `title` and `Email-Address`.
- `-Accountpassword (Read-Host -AsSecureString "AccountPassword")`: With this portion, we set the user's `password` by having the shell prompt us to enter a new password. (we can see it in the line below with the stars)
- `-Enabled $true`: We are enabling the account for use. The user could not log in if this was set to `\$False`.

Changing a user Attributes #command 
```powershell-session
Set-ADUser -Identity MTanaka -Description " Sensei to Security Analyst's Rocky, Colt, and Tum-Tum"  
```

# Working with Files and Directories
---
Get, Set, New - Means find, change and create

#### Common Commands Used for File & Folder Management

| **Command**      | **Alias**        | **Description**                                                                                         |
| ---------------- | ---------------- | ------------------------------------------------------------------------------------------------------- |
| `Get-Item`       | gi               | Retrieve an object (could be a file, folder, registry object, etc.)                                     |
| `Get-ChildItem`  | ls / dir / gci   | Lists out the content of a folder or registry hive.                                                     |
| `New-Item`       | md / mkdir / ni  | Create new objects. ( can be files, folders, symlinks, registry entries, and more)                      |
| `Set-Item`       | si               | Modify the property values of an object.                                                                |
| `Copy-Item`      | copy / cp / ci   | Make a duplicate of the item.                                                                           |
| `Rename-Item`    | ren / rni        | Changes the object name.                                                                                |
| `Remove-Item`    | rm / del / rmdir | Deletes the object.                                                                                     |
| `Get-Content`    | cat / type       | Displays the content within a file or object.                                                           |
| `Add-Content`    | ac               | Append content to a file.                                                                               |
| `Set-Content`    | sc               | overwrite any content in a file with new data.                                                          |
| `Clear-Content`  | clc              | Clear the content of the files without deleting the file itself.                                        |
| `Compare-Object` | diff / compare   | Compare two or more objects against each other. This includes the object itself and the content within. |
Location where we are:
```powershell-session
Get-Location
```

Create directory similar to mkdir #command 
```powershell-session
new-item -name "SOPs" -type directory
```
Another folder
```powershell-session
mkdir "Physical Sec"
```

Adding a file #command 
```powershell-session
new-Item "Readme.md" -ItemType File
```

Adding content to a file #command 
```powershell-session
Add-Content .\Readme.md "Title: Insert Document Title Here
```

Renaming files #command 
```powershell-session
Rename-Item .\Cyber-Sec-draft.md -NewName Infosec-SOP-draft.md
```
Several files at the same time
```powershell-session
get-childitem -Path *.txt | rename-item -NewName {$_.name -replace ".txt",".md"}
```


#### Permission Types Explained

- `Full Control`: Full Control allows for the user or group specified the ability to interact with the file as they see fit. This includes everything below, changing the permissions, and taking ownership of the file.
- `Modify`: Allows reading, writing, and deleting files and folders.
- `List Folder Contents`: This makes viewing and listing folders and subfolders possible along with executing files. This only applies to `folders`.
- `Read and Execute`: Allows users to view the contents within files and run executables (.ps1, .exe, .bat, etc.)
- `Write`: Write allows a user the ability to create new files and subfolders along with being able to add content to files.
- `Read`: Allows for viewing and listing folders and subfolders and viewing a file's contents.
- `Traverse Folder`: Traverse allows us to give a user the ability to access files or subfolders within a tree but not have access to the higher-level folder's contents. This is a way to provide selective access from a security perspective.

# Finding & Fileting Content
---
Get admin account detials #command 
```powershell-session
Get-LocalUser administrator | get-member
```

Prosperities of object
```powershell-session
Get-LocalUser administrator | Select-Object -Property *
```

Filtering
```powershell-session
Get-LocalUser * | Select-Object -Property Name,PasswordLastSet
```

Soritng
```powershell-session
Get-LocalUser * | Sort-Object -Property Name | Group-Object -property Enabled
```

Too much data
```powershell-session
Get-Service | Select-Object -Property *
```

Cleaning the results
```powershell-session
get-service | Select-Object -Property DisplayName,Name,Status | Sort-Object DisplayName | fl
```

Using `Where-Object` (`where` as an alias) and the parameter matching with `-like` will allow us to determine if we are safe to continue by looking for anything with "`Defender`" in the property. In this instance, we check the `DisplayName` property of all objects retrieved by `Get-Service`.
```powershell-session
Get-Service | where DisplayName -like '*Defender*'
```
#### Comparison Operators

| **Expression** | **Description**                                                                                                                                         |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Like`         | Like utilizes wildcard expressions to perform matching. For example, `'*Defender*'` would match anything with the word Defender somewhere in the value. |
| `Contains`     | Contains will get the object if any item in the property value matches exactly as specified.                                                            |
| `Equal` to     | Specifies an exact match (case sensitive) to the property value supplied.                                                                               |
| `Match`        | Is a regular expression match to the value supplied.                                                                                                    |
| `Not`          | specifies a match if the property is `blank` or does not exist. It will also match `$False`.                                                            |
#### Pipes
Display all windows defender info #command 
```powershell-session
Get-Service | where DisplayName -like '*Defender*' | Select-Object -Property *
```

Using pipline to count unique instances #command 
```powershell-session
et-process | sort | unique | measure-object
```
- `&&`: Sets a condition in which PowerShell will execute the next command inline `if` the current command `completes properly`.
    
- `||`: Sets a condition in which PowerShell will execute the following command inline `if` the current command `fails`.

#### Finding data within Content
Search through folder and get alll the items
```powershell-session
Get-ChildItem -Path C:\Users\MTanaka\ -File -Recurse 
```
expanded
```powershell-session
 Get-Childitem –Path C:\Users\MTanaka\ -File -Recurse -ErrorAction SilentlyContinue | where {($_.Name -like "*.txt")}
```
expanded again
```powershell-session
Get-Childitem –Path C:\Users\MTanaka\ -File -Recurse -ErrorAction SilentlyContinue | where {($_.Name -like "*.txt" -or $_.Name -like "*.py" -or $_.Name -like "*.ps1" -or $_.Name -like "*.md" -or $_.Name -like "*.csv")}
```
Display Content
```powershell-session
 Get-ChildItem -Path C:\Users\MTanaka\ -Filter "*.txt" -Recurse -File | sls "Password","credential","key"
```

Combining the searchers
```powershell-session
Get-Childitem –Path C:\Users\MTanaka\ -File -Recurse -ErrorAction SilentlyContinue | where {($_. Name -like "*.txt" -or $_. Name -like "*.py" -or $_. Name -like "*.ps1" -or $_. Name -like "*.md" -or $_. Name -like "*.csv")} | sls "Password","credential","key","UserName"
```
Where to look for interesting info
- Looking in a Users `\AppData\` folder is a great place to start. Many applications store `configuration files`, `temp saves` of documents, and more.
- A Users home folder `C:\Users\User\` is a common storage place; things like VPN keys, SSH keys, and more are stored. Typically in `hidden` folders. (`Get-ChildItem -Hidden`)
- The Console History files kept by the host are an endless well of information, especially if you land on an administrator's host. You can check two different points:
    - `C:\Users\<USERNAME>\AppData\Roaming\Microsoft\Windows\Powershell\PSReadline\ConsoleHost_history.txt`
    - `Get-Content (Get-PSReadlineOption).HistorySavePath`
- Checking a user's clipboard may also yield useful information. You can do so with `Get-Clipboard`
- Looking at Scheduled tasks can be helpful as well.

# Working with Services
---
PowerShell provides us with the module `Microsoft.PowerShell.Management`, which contains several cmdlets for interacting with Services. There are 3 categories of services in windows: Local, Network and System

Services info #command 
```powershell-session
Get-Help *-Service  
```
To display all services #command 
```powershell-session
Get-Service | ft DisplayName,Status 
```
Narrowing down the search
```powershell-session
Get-Service | where DisplayName -like '*Defender*' | ft DisplayName,ServiceName,Status
```
How to start a service #command 
```powershell-session
Start-Service WinDefend
```
Checking the service is indeed running
```powershell-session
get-service WinDefend
```
Stopping the service #command 
```powershell-session
Stop-Service Spooler 
```

Changing the service
```powershell-session
Set-Service -Name Spooler -StartType Disabled
```
We can remove Remove-Service in PowerShell 7 otherwise sc.exe tool needs to be used for that.

#### Interacting with remote services
Query another computer in the domain #command 
```powershell-session
get-service -ComputerName ACADEMY-ICL-DC
```
More detials
```powershell-session
Get-Service -ComputerName ACADEMY-ICL-DC | Where-Object {$_.Status -eq "Running"}
```

getting results from local and remote machine #command 
```powershell-session
invoke-command -ComputerName ACADEMY-ICL-DC,LOCALHOST -ScriptBlock {Get-Service -Name 'windefend'}
```

- `Invoke-Command`: We are telling PowerShell that we want to run a command on a local or remote computer.
- `Computername`: We provide a comma-defined list of computer names to query.
- `ScriptBlock {commands to run}`: This portion is the enclosed command we want to run on the computer. For it to run, we need it to be enclosed in {}.


# Working with the Registry
---
The Registry is a hierarchical tree containing **keys and values** that store essential information for the operating system and installed software, such as settings and installation directories. For pentesters, the Registry is valuable for finding information, planting persistence, and understanding potential threat actor activities as outlined by MITRE.

**Keys:**
-  Host systems Registry `root keys` are stored in several different files and can be accessed from `C:\Windows\System32\Config
- `htb> Get-ChildItem C:\Windows\System32\config\`
![[registry.webp]]

**Values:**
![[registry-values.webp]]

#### Registry Hives
The Registry is crucial for pentesters because it centralizes extensive information about the system and installed software, making it a valuable resource for gathering intelligence and making widespread changes, although it's challenging for defenders to monitor due to its size and complexity.

| **Name**            | **Abbreviation** | **Description**                                                                                                                                                                                                                                                                                                        |
| ------------------- | ---------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| HKEY_LOCAL_MACHINE  | `HKLM`           | This subtree contains information about the computer's `physical state`, such as hardware and operating system data, bus types, memory, device drivers, and more.                                                                                                                                                      |
| HKEY_CURRENT_CONFIG | `HKCC`           | This section contains records for the host's `current hardware profile`. (shows the variance between current and default setups) Think of this as a redirection of the [HKLM](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc739525(v=ws.10)) CurrentControlSet profile key. |
| HKEY_CLASSES_ROOT   | `HKCR`           | Filetype information, UI extensions, and backward compatibility settings are defined here.                                                                                                                                                                                                                             |
| HKEY_CURRENT_USER   | `HKCU`           | Value entries here define the specific OS and software settings for each specific user. `Roaming profile` settings, including user preferences, are stored under HKCU.                                                                                                                                                 |
| HKEY_USERS          | `HKU`            | The `default` User profile and current user configuration settings for the local computer are defined under HKU.                                                                                                                                                                                                       |
hello