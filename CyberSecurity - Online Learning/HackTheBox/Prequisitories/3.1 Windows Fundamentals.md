---
Date: 2024-01-10T15:39:00
Summary: Windows essentials for security
---
# Introduction
---

#HTB #windows 
Table of contents >>> [[Hack The Box]]

**System information: #command**
```powershell-session
PS C:\htb> Get-WmiObject -Class win32_OperatingSystem | select Version,BuildNumber

Version    BuildNumber
-------    -----------
10.0.19041 19041
```

**Get-WmiObject variations #command**:

| Command | Description |
| ---- | ---- |
| `Win32_ Process` | process listing |
| `Win32_Bios` | Bios information |
| `Win32_Service` | List of all services |
# Remote connections
RDR Remote Desktop - Connection for windows is a tools used to connect to another **windows system**.

![[SavingRDPConnections.gif]]

xfreerdp - is a linux tools used to connect **linux** machine to windows #command .

```shell-session
lukan1u@htb[/htb]$ xfreerdp /v:<targetIp> /u:htb-student /p:Password
```

# Core of Operating system structure
Boot directory:

|Directory|Function|
|---|---|
|Perflogs|Can hold Windows performance logs but is empty by default.|
|Program Files|On 32-bit systems, all 16-bit and 32-bit programs are installed here. On 64-bit systems, only 64-bit programs are installed here.|
|Program Files (x86)|32-bit and 16-bit programs are installed here on 64-bit editions of Windows.|
|ProgramData|This is a hidden folder that contains data that is essential for certain installed programs to run. This data is accessible by the program no matter what user is running it.|
|Users|This folder contains user profiles for each user that logs onto the system and contains the two folders Public and Default.|
|Default|This is the default user profile template for all created users. Whenever a new user is added to the system, their profile is based on the Default profile.|
|Public|This folder is intended for computer users to share files and is accessible to all users by default. This folder is shared over the network by default but requires a valid network account to access.|
|AppData|Per user application data and settings are stored in a hidden user subfolder (i.e., cliff.moore\AppData). Each of these folders contains three subfolders. The Roaming folder contains machine-independent data that should follow the user's profile, such as custom dictionaries. The Local folder is specific to the computer itself and is never synchronized across the network. LocalLow is similar to the Local folder, but it has a lower data integrity level. Therefore it can be used, for example, by a web browser set to protected or safe mode.|
|Windows|The majority of the files required for the Windows operating system are contained here.|
|System, System32, SysWOW64|Contains all DLLs required for the core features of Windows and the Windows API. The operating system searches these folders any time a program asks to load a DLL without specifying an absolute path.|
|WinSxS|The Windows Component Store contains a copy of all Windows components, updates, and service packs.|
## File system

**Pros of NTFS**
- NTFS is reliable and can restore the consistency of the file system in the event of a system failure or power loss.
- Provides security by allowing us to set granular permissions on both files and folders.
- Supports very large-sized partitions.
- Has journaling built-in, meaning that file modifications (addition, modification, deletion) are logged.

**Cons of NTFS:**

- Most mobile devices do not support NTFS natively.
- Older media devices such as TVs and digital cameras do not offer support for NTFS storage devices.

|**Permission Type** |**Description** |
|---|---|
|Full Control|Allows reading, writing, changing, deleting of files/folders.|
|Modify|Allows reading, writing, and deleting of files/folders.|
|List Folder Contents|Allows for viewing and listing folders and subfolders as well as executing files. Folders only inherit this permission.|
|Read and Execute|Allows for viewing and listing files and subfolders as well as executing files. Files and folders inherit this permission.|
|Write|Allows for adding files to folders and subfolders and writing to a file.|
|Read|Allows for viewing and listing of folders and subfolders and viewing a file's contents.|
|Traverse Folder|This allows or denies the ability to move through folders to reach other files or folders. For example, a user may not have permission to list the directory contents or view files in the documents or web apps directory in this example c:\users\bsmith\documents\webapps\backups\backup_02042020.zip but with Traverse Folder permissions applied, they can access the backup archive.|
Files and folders *inherit the NTFS permissions of their parent folder* for ease of administration, so administrators do not need to explicitly set permissions for each file and folder.

# Integrity Control Access Control List (icacls)
**To list permissions of  directory #command**
``` Lists chosen directory permissions
icacls C:\Windows
```

```

```cmd-session
c:\windows NT SERVICE\TrustedInstaller:(F)
           NT SERVICE\TrustedInstaller:(CI)(IO)(F)
           NT AUTHORITY\SYSTEM:(M)
           NT AUTHORITY\SYSTEM:(OI)(CI)(IO)(F)
           BUILTIN\Administrators:(M)
           BUILTIN\Administrators:(OI)(CI)(IO)(F)
           BUILTIN\Users:(RX)
           BUILTIN\Users:(OI)(CI)(IO)(GR,GE)
           CREATOR OWNER:(OI)(CI)(IO)(F)
           APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(RX)
           APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(OI)(CI)(IO)(GR,GE)
           APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(RX)
           APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(OI)(CI)(IO)(GR,GE)
```

**Inheritance from folders:**
- `(CI)`: container inherit
- `(OI)`: object inherit
- `(IO)`: inherit only
- `(NP)`: do not propagate inherit
- `(I)`: permission inherited from parent container
**Access to that specific folder etc**
- `F` : full access
- `D` :  delete access
- `N` :  no access
- `M` :  modify access
- `RX` :  read and execute access
- `R` :  read-only access
- `W` :  write-only access

# NTFS vs. Share Permissions
The Server Message Block protocol (**SMB**) is used in windows to connect shared resources like files and printers.
![[Pasted image 20240111184946.png]]

NTFS permissions are similar to share permissions however they are not the same.
**Share permissions:**

| Permission     | Description                                                                                                                                 |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------- |
| `Full Control` | Users are permitted to perform all actions given by Change and Read permissions as well as change permissions for NTFS files and subfolders |
| `Change`       | Users are permitted to read, edit, delete and add files and subfolders                                                                      |
| `Read`         | Users are allowed to view file & subfolder contents                                                                                         |

**NTFS Basic permissions:**

|Permission|Description|
|---|---|
|`Full Control`|Users are permitted to add, edit, move, delete files & folders as well as change NTFS permissions that apply to all allowed folders|
|`Modify`|Users are permitted or denied permissions to view and modify files and folders. This includes adding or deleting files|
|`Read & Execute`|Users are permitted or denied permissions to read the contents of files and execute programs|
|`List folder contents`|Users are permitted or denied permissions to view a listing of files and subfolders|
|`Read`|Users are permitted or denied permissions to read the contents of files|
|`Write`|Users are permitted or denied permissions to write changes to a file and add new files to a folder|
|`Special Permissions`|A variety of advanced permissions options|
 
 **NTFS special permissions:**
 
|Permission|Description|
|---|---|
|`Full control`|Users are permitted or denied permissions to add, edit, move, delete files & folders as well as change NTFS permissions that apply to all permitted folders|
|`Traverse folder / execute file`|Users are permitted or denied permissions to access a subfolder within a directory structure even if the user is denied access to contents at the parent folder level. Users may also be permitted or denied permissions to execute programs|
|`List folder/read data`|Users are permitted or denied permissions to view files and folders contained in the parent folder. Users can also be permitted to open and view files|
|`Read attributes`|Users are permitted or denied permissions to view basic attributes of a file or folder. Examples of basic attributes: system, archive, read-only, and hidden|
|`Read extended attributes`|Users are permitted or denied permissions to view extended attributes of a file or folder. Attributes differ depending on the program|
|`Create files/write data`|Users are permitted or denied permissions to create files within a folder and make changes to a file|
|`Create folders/append data`|Users are permitted or denied permissions to create subfolders within a folder. Data can be added to files but pre-existing content cannot be overwritten|
|`Write attributes`|Users are permitted or denied to change file attributes. This permission does not grant access to creating files or folders|
|`Write extended attributes`|Users are permitted or denied permissions to change extended attributes on a file or folder. Attributes differ depending on the program|
|`Delete subfolders and files`|Users are permitted or denied permissions to delete subfolders and files. Parent folders will not be deleted|
|`Delete`|Users are permitted or denied permissions to delete parent folders, subfolders and files.|
|`Read permissions`|Users are permitted or denied permissions to read permissions of a folder|
|`Change permissions`|Users are permitted or denied permissions to change permissions of a file or folder|
|`Take ownership`|Users are permitted or denied permission to take ownership of a file or folder. The owner of a file has full permissions to change any permissions|

Permissions apply to the system where the folder is being stored. Also it is possible to set custom  permission on parent and subfolders if needed.

# How to create ad network share
1. Creation folder and using gui go to folder properties and navigate to share tab
2. Then to to advanced sharing and click on share this folder.

![[Pasted image 20240111190141.png]]

**ACL** access control list for specific rules and settings. Typically these ACEs are made up of `users` & `groups`
![[Pasted image 20240111190305.png]]

## Using smbclient to connect to the share and test if it works.
It is the Windows Defender Firewall that could potentially be blocking access to the SMB share. Since we are connecting from a Linux-based system the firewall has blocked access from any device that is not joined to the same `workgroup`. It is also important to note that when a Windows system is part of a workgroup, all `netlogon` requests are authenticated against that particular Windows system's `SAM` database. When a Windows system is joined to a Windows Domain environment, all netlogon requests are authenticated against `Active Directory`. The primary difference between a workgroup and a Windows Domain in terms of authentication, is with a workgroup the local SAM database is used and in a Windows Domain a centralized network-based database (Active Directory) is used. We must know this information when attempting to logon & authenticate with a Windows system. Consider where the htb-student account is hosted to properly connect to the target.

In terms of the firewall blocking connections, this can be tested by completely deactivating each firewall profile in Windows or by enabling specific predefined inbound firewall rules in the `Windows Defender Firewall advanced security settings`. Like most firewalls, Windows Defender Firewall permits or denies traffic (access & connection requests in this case) flowing `inbound` &/or `outbound`

The different inbound and outbound rules are associated with the different firewall profiles in defender.

Windows Defender Firewall Profiles:
e3
- `Public`
- `Private`
- `Domain`

It is a best practice to enable predefined rules or add custom exceptions rather than deactivating the firewall altogether. Unfortunately, it is very common for firewalls to be left completely deactivated for the sake of convenience or lack of understanding. Firewall rules on desktop systems can be centrally managed when joined to a Windows Domain environment through the use of Group Policy. Group Policy concepts and configurations are outside of the scope of this module.

Once the proper `inbound` firewall rules are enabled we will successfully connect to the share. Keep in mind that we can only connect to the share because the user account we are using (`htb-student`) is in the `Everyone group`. Recall that we left the specific share permissions for the Everyone group set to Read, which quite literally means we will only be able to Read files on this share. Once a connection is established with a share, we can create a `mount point` from our Pwnbox to the Windows 10 target box's file system. This is where we must also consider that NTFS permissions apply alongside share permissions. Recall that NTFS is the default file system in Windows. Lets jump back to our xfreerdp session with our Windows 10 target box and take a look at the NTFS permissions on the Company Data folder.

*Any device trying to access SMB share that is not part of the same workgroup will be blocked by windows firewall. In the setting for the firewall you will have to add inbound `tcp port 445` that is used by SMB protocol. Otherwise you will not be able to connect. #protocol*

**Connecting Share smbclient #command**
```shell-session
[!bash!]$ smbclient -L IPaddressOfTarget -U htb-student
```

**Installing CIFS Utilities #command** 

```shell-session
[!bash!]$ sudo apt-get install cifs-utils
```

**Mounting to the share #command**
```shell-session
sudo mount -t cifs -o username=htb-student,password=Academy_WinFun! //ipaddoftarget/"Company Data" /home/user/Desktop/
```

`net share` is a useful command to check all shared folder on windows system. Computer management software can be used to check the same info #command 
```cmd-session
C:\Users\htb-student> net share

Share name   Resource                        Remark

-------------------------------------------------------------------------------
C$           C:\                             Default share
IPC$                                         Remote IPC
ADMIN$       C:\WINDOWS                      Remote Admin
Company Data C:\Users\htb-student\Desktop\Company Data
```

 **Viewing Share access logs in Event Viewer**
- Event viewer is an excellent logging software. It can shows all the logins and attempted connection to the shared folder.

# Working with services and processes
---

## Windows Services

Windows services are managed via **Service Control Manager** (SCM) accessible via the `services.msc` MMC add-in.

**Displays first 2 services running #command**:

```powershell-session
PS C:\htb> Get-Service | ? {$_.Status -eq "Running"} | select -First 2 |fl
```

There 2 states the services can be:
- Running
- Sopped
  There are 3 catogories:
  - Local Services
  - Network Services
  - System services

Windows has also `critical system services` that cannot be stopped without system restart. If any of these files is updated it will require system reset.

| Service | Description |
| ---- | ---- |
| smss.exe | Session Manager SubSystem. Responsible for handling sessions on the system. |
| csrss.exe | Client Server Runtime Process. The user-mode portion of the Windows subsystem. |
| wininit.exe | Starts the Wininit file .ini file that lists all of the changes to be made to Windows when the computer is restarted after installing a program. |
| logonui.exe | Used for facilitating user login into a PC |
| lsass.exe | The Local Security Authentication Server verifies the validity of user logons to a PC or server. It generates the process responsible for authenticating users for the Winlogon service. |
| services.exe | Manages the operation of starting and stopping services. |
| winlogon.exe | Responsible for handling the secure attention sequence, loading a user profile on logon, and locking the computer when a screensaver is running. |
| System | A background system process that runs the Windows kernel. |
| svchost.exe with RPCSS | Manages system services that run from dynamic-link libraries (files with the extension .dll) such as "Automatic Updates," "Windows Firewall," and "Plug and Play." Uses the Remote Procedure Call (RPC) Service (RPCSS). |
| svchost.exe with Dcom/PnP | Manages system services that run from dynamic-link libraries (files with the extension .dll) such as "Automatic Updates," "Windows Firewall," and "Plug and Play." Uses the Distributed Component Object Model (DCOM) and Plug and Play (PnP) services. |
| Wiki | [List of all the MS windows components](https://en.wikipedia.org/wiki/List_of_Microsoft_Windows_components#Services) |
## Processes
Run in the background of Windows system. They don't have to be part of the OS and can be started by other applications. Some of the are critical and they shouldn't be stopped. These include:
- Windows Logon Application 
- System
- System Idle Process
- Windows Start-Up Application
- Client Server Runtime
- Windows Session Manager
- Service Host
- Local Security Authority Subsystem Service (LSASS) process

## Local Security Authority Subsystem (LSASS)

- `lsass.exe` is the process responsible for security policy on Windows systems. When user attempts to login to the system, this process verifies their login details and create access token based on permission levels of a user.
- Produces Windows Security Logs
- Also manages password changes
- HIGHLY TARGETED to extract data from.

## SysInternal Tools

The SysInternals Tools suite are portable Windows applications that can be used to administer Windows system without installation for the most part. SysInternal tools installation Location in Windows File Explorer:

`\\live.sysinternals.com\tools` network storage #command 

The suite includes tools such as `Process Explorer`, an enhanced version of `Task Manager`, and `Process Monitor`, which can be used to monitor file system, registry, and network activity related to any process running on the system.

## Task Manager
| Tab | Description |
| ---- | ---- |
| Processes tab | Shows a list of running applications and background processes along with the CPU, memory, disk, network, and power usage for each. |
| Performance tab | Shows graphs and data such as CPU utilization, system uptime, memory usage, disk and, networking, and GPU usage. We can also open the `Resource Monitor`, which gives us a much more in-depth view of the current CPU, Memory, Disk, and Network resource usage. |
| App history tab | Shows resource usage for the current user account for each application for a period of time. |
| Startup tab | Shows which applications are configured to start at boot as well as the impact on the startup process. |
| Users tab | Shows logged in users and the processes/resource usage associated with their session. |
| Details tab | Shows the name, process ID (PID), status, associated username, CPU, and memory usage for each running application. |
| Services tab | Shows the name, PID, description, and status of each installed service. The Services add-in can be accessed from this tab as well. |
|  |  |
## Process Explorer

Process Explorer is a part of the SysInternals tool suite. This tool can show which handles and DLL processes are loaded when a program runs. Process Explorer shows a list of currently running processes, and from there, we can see what handles the process has selected in one view or the DLLs and memory-swapped files that have been loaded in another view. he tool can also be used to analyse parent-child process relationships to see what child processes are spawned by an application

# Service Permissions
---

- \Windows services are vital for long-running processes therefore they are often targeted in cyber attacks.
- Critical network services like DHCP and Active Directory Domain services are installed using admin account. Therefore it's essential for a company to have service accounts as those services are assigned with that specific user and can be run through that user. 
- Services permissions and the permissions of the directories they execute from are vital in the system protection.

## Examining Services using services.msc

`services.msc` manage everything with all services. #command 

![[Pasted image 20240113165613.png]]

- If the **directory of a service is configured with weak permission**, an attacker could use it to replace the original exe with ones used for malicious purposes. 
- Most services run with **Local System privileges** which is the highest level access allowed on the individual Windows OS. Not all applications installed by a user need that and we always should adhere to **principle of least privilege**. 
- Service accounts in Windows are but also new users can be added with the sole purpose of running a service:
	- **LocalService**
	- **NetworkService**
	- **LocalSystem**
- Recovery for these services should be also configured properly
![[Pasted image 20240113170852.png]]


## Examining services using sc
`sc qc` is a command used to query the service.

**Display information about the service** #command 
```cmd-session
sc qc wuauserv
```

**Display information about the service whilst being on the network** #command 
```cmd-session
sc //hostname or ip of box query ServiceName
```

**Start/ Stop of a service** #command 
```cmd-session
sc stop wuauserv
```

**Examining service permissions DACL** #command 
```cmd-session
sc sdshow wuauserv
```

Every named object is a **securable object** and some unnamed objects are securable. Every securable object has security descriptor. Security descriptor identify the object's owner and a primary group containing a Discretionary Access Control List (**DACL**) and System Access Control List (**SACL**). Generally, a DACL is used for controlling access to an object, and a SACL is used to account for and log access attempts.
![[Pasted image 20240113172647.png]]

`Security Descriptor Definition Language` (`SDDL`)
```
D:(A;;CCLCSWRPLORC;;;AU)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;SY)
```
1. D: - the proceeding characters are DACL permissions
2. AU: - defines the security principal Authenticated Users
3. A;; - access is allowed
4. CC - SERVICE_QUERY_CONFIG is the full name, and it is a query to the service control manager (SCM) for the service configuration
5. LC - SERVICE_QUERY_STATUS is the full name, and it is a query to the service control manager (SCM) for the current status of the service
6. SW - SERVICE_ENUMERATE_DEPENDENTS is the full name, and it will enumerate a list of dependent services
7. RP - SERVICE_START is the full name, and it will start the service
8. LO - SERVICE_INTERROGATE is the full name, and it will query the service for its current status
9. RC - READ_CONTROL is the full name, and it will query the security descriptor of the service

`;;CCLCSWRPLORC;;;`
After the last set of semi-colons, the characters specify the security principal (User and/or Group) that is permitted to perform those actions.

`;;;AU`
The character immediately after the opening parentheses and before the first set of semi-colons defines whether the actions are Allowed or Denied.

`A;;`
This entire security descriptor associated with the `Windows Update` (`wuauserv`) service has three sets of access control entries because there are three different security principals. Each security principal has specific permissions applied.

## Examine Service permission using PowerShell
Get-Acl exmines service permissions #command 
```powershell-session
Get-ACL -Path HKLM:\System\CurrentControlSet\Services\wuauserv | Format-List
```

The reason for using command line commands it because it's easy to script them and create better automation. Also command above gives more readable content than sc qc. Still includes **SDDL**.

nteraction with Windows
---

## Windows Sessions
- **Interactive** - Local logon session initiated by a used authenticating to a local or domain system by entering their credentials. An interactive logon can be initiated by logging directly into the system.
- **Non-interactive** - they do not require login credentials. There are 3 types: Local System Account. Local Service Account, Network Service Account. These are used by Windows to automatically start services because each service needs a "user" to start them.

| Account | Description |
| ---- | ---- |
| Local System Account | Also known as the `NT AUTHORITY\SYSTEM` account, this is the most powerful account in Windows systems. It is used for a variety of OS-related tasks, such as starting Windows services. This account is more powerful than accounts in the local administrators group. |
| Local Service Account | Known as the `NT AUTHORITY\LocalService` account, this is a less privileged version of the SYSTEM account and has similar privileges to a local user account. It is granted limited functionality and can start some services. |
| Network Service Account | This is known as the `NT AUTHORITY\NetworkService` account and is similar to a standard domain user account. It has similar privileges to the Local Service Account on the local machine. It can establish authenticated sessions for certain network services. |

# Interacting with the Windows Operating System
---

## Graphical User Interface
An interface that allows casual users use the PC without touching command line. It is used by the administrators to ease their work conditions.

## Remote Desktop Protocol (RDP)
It's a Microsoft #protocol which allows user to connect to remote system over the network. RDP uses port 3389 which sends data back and forth. Unlike SSH user is able to access GUI applications alongside the command line applications. It can be also used to access local network via virtual private network (VPN).

## Windows Command Line
Greater control over the system including admin and troubleshooting tasks. It can also be used for automation and writing scripts.

## CMD
Command Prompt is used to enter and execute commands such as ipconfig, schedule tasks or create scripts and batch files.

**How to show more detailed help** #command 
```cmd-session
ipconfig /?
```
## PowerShell
It was created mostly for system administrators. PowerShell is built on top of the .NET Framework which is used for building and running applications on Windows. Like the command prompt, PowerShell gives us direct access to the file system, and we run the majority of the same commands that we can within `a cmd shell.

## Cmdlets
PowerShell is using cmdlets which are small single function tools built into the shell. Bascially it's the commands such as `cd` and `ls`. Cmdlets are in the form **Verb-Noun**. `Get-ChildItem` is used to list current directory. `Get-ChildItem -Recurse` similar to tree.

**Display directories** #command 
```Shell
Get-ChildItem
Get-ChildItem -Recurse
Get-ChildItem -Path C:\Users\Administrator\Documents
Get-ChildItem -Path C:\Users\Administrator\Downloads -Recurse
```

## Aliases
Many cmdlets have aliases such `Set-location = cd, Get-ChildItem = ls `

**Display aliases** #command 
```powershell-session
get-alias
```

**CreateNew-Alias** #command 
```powershell-session
New-Alias -Name "Show-Files" Get-ChildItem
```

**Open Online help** #command 
```
Get-Help <cmdlet-name> -Online
```

**Installing help package** #command 
```powershell-session
Get-Help Get-AppPackage
```

# Running Scripts

PowerShell ISE (Integrated Scripting Environment) allows us to write scripts on the fly. It has autocomplete/lookup function for PowerShell commands. Scrips can be written in the same console, useful for quick debugging.

**Loading into memory with a download cradle** #command 
```powershell-session
 .\PowerView.ps1;Get-LocalGroup |fl
```
1. `.\PowerView.ps1`: This portion of the command is attempting to execute the PowerView PowerShell script. The `.\` indicates that the script is in the current directory.
    
2. `Get-LocalGroup`: This is a PowerShell cmdlet that is part of PowerView. It is used to retrieve information about local groups on a Windows system. In this context, it's likely being used to enumerate the local groups on the target system.
    
3. `|fl`: This is a pipeline operator in PowerShell. It takes the output from the previous command (`Get-LocalGroup`) and sends it as input to the next command (`fl`). `fl` is an alias for the `Format-List` cmdlet, which formats the output as a list. This is used to display the information in a more detailed format.

**Imports module like python packages in a sense** #command 
```
Import-Module .\PowerView.ps1
```

**Lists all the loaded modules and their commands** #command 
```powershell-session
Get-Module | select Name,ExportedCommands | fl
```

## Execution Policy
Execution policy will determine which commands we can run or not

|**Policy**|**Description**|
|---|---|
|`AllSigned`|All scripts can run, but a trusted publisher must sign scripts and configuration files. This includes both remote and local scripts. We receive a prompt before running scripts signed by publishers that we have not yet listed as either trusted or untrusted.|
|`Bypass`|No scripts or configuration files are blocked, and the user receives no warnings or prompts.|
|`Default`|This sets the default execution policy, `Restricted` for Windows desktop machines and `RemoteSigned` for Windows servers.|
|`RemoteSigned`|Scripts can run but requires a digital signature on scripts that are downloaded from the internet. Digital signatures are not required for scripts that are written locally.|
|`Restricted`|This allows individual commands but does not allow scripts to be run. All script file types, including configuration files (`.ps1xml`), module script files (`.psm1`), and PowerShell profiles (`.ps1`) are blocked.|
|`Undefined`|No execution policy is set for the current scope. If the execution policy for ALL scopes is set to undefined, then the default execution policy of `Restricted` will be used.|
|`Unrestricted`|This is the default execution policy for non-Windows computers, and it cannot be changed. This policy allows for unsigned scripts to be run but warns the user before running scripts that are not from the local intranet zone|
**Execution policy** #command
```powershell-session
Get-ExecutionPolicy -List
```
The execution policy in PowerShell isn't a strict security measure to limit user actions. Users can easily get around it by directly typing script content into PowerShell, downloading and running scripts, or encoding and executing scripts. It can also be bypassed by adjusting the execution policy (if the user has the right permissions) or by setting the execution policy for the current session (which almost any user can do without making permanent changes).

**Changing execution policy** #command 
```powershell-session
Set-ExecutionPolicy Bypass -Scope Process
```

# Windows Management Instrumentation (WMI)
WMI is a subsystem of PowerShell that provides system administrators with powerful tools and system monitoring. It consolidates device and applications management across corporate networks. It is made up of the following components:

|**Component Name**|**Description**|
|---|---|
|WMI service|The Windows Management Instrumentation process, which runs automatically at boot and acts as an intermediary between WMI providers, the WMI repository, and managing applications.|
|Managed objects|Any logical or physical components that can be managed by WMI.|
|WMI providers|Objects that monitor events/data related to a specific object.|
|Classes|These are used by the WMI providers to pass data to the WMI service.|
|Methods|These are attached to classes and allow actions to be performed. For example, methods can be used to start/stop processes on remote machines.|
|WMI repository|A database that stores all static data related to WMI.|
|CIM Object Manager|The system that requests data from WMI providers and returns it to the application requesting it.|
|WMI API|Enables applications to access the WMI infrastructure.|
|WMI Consumer|Sends queries to objects via the CIM Object Manager.|
Some of the uses for WMI are:
- Status information for local/remote systems
- Configuring security settings on remote machines/applications
- Setting and changing user and group permissions
- Setting/modifying system properties
- Code execution
- Scheduling processes
- Setting up logging

Lists information about the os #command 
```powershell-session
Get-WmiObject -Class Win32_OperatingSystem | select SystemDirectory,BuildNumber,SerialNumber,Version | ft

wmic os list brief
```


Creates new file #command 
```powershell-session
Invoke-WmiMethod -Path "CIM_DataFile.Name='C:\users\public\spns.csv'" -Name Rename -ArgumentList "C:\Users\Public\kerberoasted_users.csv"
```
- **`Invoke-WmiMethod`**: This is the cmdlet used to invoke a method of a WMI class.
- **`-Path "CIM_DataFile.Name='C:\users\public\spns.csv'"`**: Specifies the path to the instance of the WMI class on which the method should be invoked. In this case, it targets a file with the name 'spns.csv' in the 'C:\users\public' directory.
- **`-Name Rename`**: Specifies the name of the method to be invoked. In this case, it's the `Rename` method.
- **`-ArgumentList "C:\Users\Public\kerberoasted_users.csv"`**: Provides arguments to the method being invoked. Here, it specifies the new name for the file, which is 'kerberoasted_users.csv' in the 'C:\Users\Public' directory.

# Microsoft Management Console (MMC)
Is a tool to be used for group snap-ins or administrative tools to mange hardware, software and network components within a Windows host. We can use MMC to create custom tools such as snap-ins allowing administrators to create a customized console with only the administrative tools needed to manage several services.

We can open MMC by just typing `mmc` in the Start menu. When we open MMC for the first time, it will be blank.

![image](https://academy.hackthebox.com/storage/modules/49/MMC.png)

From here, we can browse to File --> `Add or Remove Snap-ins`, and begin customizing our administrative console.

![image](https://academy.hackthebox.com/storage/modules/49/MMC_add_remove.png)

As we begin adding snap-ins, we will be asked if we want to add the snap-in to manage just the local computer or if it will be used to manage another computer on the network.

![image](https://academy.hackthebox.com/storage/modules/49/MMC_services.png)

# Desktop Experience vs. Server Core
Server Core has lower management requirements, a smaller attack surface, and uses less disk space and memory than its Desktop Experience (GUI) counterpart. In Server Core, all configuration and maintenance tasks are performed via the command-line, PowerShell, or remote management with MMC or Remote Server Administration Tools (RSAT)

| **Application** | **Server Core** | **Desktop Experience** |
| ---- | ---- | ---- |
| Command prompt | Available | Available |
| Windows PowerShell/ Microsoft .NET | Available | Available |
| Regedit | Available | Available |
| Diskmgmt.msc | Not Available | Available |
| Server Manager | Not Available | Available |
| Mmc.exe | Not Available | Available |
| Eventvwr | Not Available | Available |
| Services.msc | Not Available | Available |
| Control Panel | Not Available | Available |
| Windows Explorer | Not Available | Available |
| Taskmgr | Available | Available |
| Internet Explorer or Edge | Not Available | Available |
| Remote Desktop Services | Available | Available |

# Windows Security
---

## Security Identifier (SID)
- Each security principals has a unique security identifier (SID)
- System automatically generates SIDs
- Two identical user can be distinguished by Windows based on their SID
- SID are string values  stored in the security database
- SIDs are added to the user's access token to identify all actions
- SID consists of the **Identifier Authority** and the **Relative ID (RID)**. In an Active Directory (AD). The SID also includes the domain SID.

SID of a user #command 
```powershell-session
whoami /user
```
Command Explanation:
(SID)-(revision level)-(identifier-authority)-(subauthority1)-(subauthority2)-(etc)

|**Number**|**Meaning**|**Description**|
|---|---|---|
|S|SID|Identifies the string as a SID.|
|1|Revision Level|To date, this has never changed and has always been `1`.|
|5|Identifier-authority|A 48-bit string that identifies the authority (the computer or network) that created the SID.|
|21|Subauthority1|This is a variable number that identifies the user's relation or group described by the SID to the authority that created it. It tells us in what order this authority created the user's account.|
|674899381-4069889467-2080702030|Subauthority2|Tells us which computer (or domain) created the number|
|1002|Subauthority3|The RID that distinguishes one account from another. Tells us whether this user is a normal user, a guest, an administrator, or part of some other group|

## Security Accounts Manager (SAM) and Access Control Entries (ACE)

- SAM grants rights to a network to execute specific processes
- The rights themselves are manged by Access Control Entries **(ACE)** in Access Control Lists **(ACL)**.
- The ACLs contain ACEs that define which users, groups, or processes have access to a file or to execute a process.
- **Security Descriptor and Object Access Permissions**:
    - Permissions granted by the security descriptor.
    - Classified into two types of Access Control Lists (ACLs):
        - Discretionary Access Control List (DACL)
        - System Access Control List (SACL)
- **Authorization Process for Threads and Processes**:
    - Every thread and process initiated by a user undergoes an authorization process.
- **Access Tokens in the Authorization Process**:
    - Access tokens play a crucial role in the authorization process.
    - Validated by the Local Security Authority (LSA)
- **Information Contained in Access Tokens**:
    - Access tokens contain more than just Security Identifier (SID).
    - Hold other security-relevant information.

## User Account Control (UAC)

Is a security features in Windows to prevent malware and scripts from running or manipulating processes that could damage the computer. There is the Admin Approval Mode in UAC which prevents software installation without admin consent.
![[Pasted image 20240116190407.png]]


## Registry
Is a hierarchical database in Windows critical for the operating system. It stores low-level settings for the Windows operating system and applications that choose to use it. Divided between computer/user specific data
![[Pasted image 20240116190627.png]]

The tree-structure consists of main folders (root keys) in which subfolders (subkeys) with their entries/files (values) are located:

|**Value**|**Type**|
|---|---|
|REG_BINARY|Binary data in any form.|
|REG_DWORD|A 32-bit number.|
|REG_DWORD_LITTLE_ENDIAN|A 32-bit number in little-endian format. Windows is designed to run on little-endian computer architectures. Therefore, this value is defined as REG_DWORD in the Windows header files.|
|REG_DWORD_BIG_ENDIAN|A 32-bit number in big-endian format. Some UNIX systems support big-endian architectures.|
|REG_EXPAND_SZ|A null-terminated string that contains unexpanded references to environment variables (for example, "%PATH%"). It will be a Unicode or ANSI string depending on whether you use the Unicode or ANSI functions. To expand the environment variable references, use the [**ExpandEnvironmentStrings**](https://docs.microsoft.com/en-us/windows/win32/api/processenv/nf-processenv-expandenvironmentstringsa) function.|
|REG_LINK|A null-terminated Unicode string containing the target path of a symbolic link created by calling the [**RegCreateKeyEx**](https://docs.microsoft.com/en-us/windows/desktop/api/Winreg/nf-winreg-regcreatekeyexa) function with REG_OPTION_CREATE_LINK.|
|REG_MULTI_SZ|A sequence of null-terminated strings, terminated by an empty string (\0). The following is an example: _String1_\0_String2_\0_String3_\0_LastString_\0\0 The first \0 terminates the first string, the second to the last \0 terminates the last string, and the final \0 terminates the sequence. Note that the final terminator must be factored into the length of the string.|
|REG_NONE|No defined value type.|
|REG_QWORD|A 64-bit number.|
|REG_QWORD_LITTLE_ENDIAN|A 64-bit number in little-endian format. Windows is designed to run on little-endian computer architectures. Therefore, this value is defined as REG_QWORD in the Windows header files.|
|REG_SZ|A null-terminated string. This will be either a Unicode or an ANSI string, depending on whether you use the Unicode or ANSI functions.|
- Each folder under Computer is a key.
- The root keys start with HKEY
- HKEY-LOCAL-MACHINE abbreviated to HKLM
- HKLM contains all settings relevant to the local system.
	- This root key contains six subkeys like SAM, SECURITY, SYSTEM, SOFTWARE, HARDWARE, BCD loaded into memory at boot time except HARDWARE which is dynamically loaded.

Entire system registry #command 
`C:\Windows\System32\Config\`.

The user-specific registry hive HKCU is stored in the user folder `C:\Users\<USERNAME>\Ntuser.dat`
To view hidden files in PowerShell: #command 
```powershell-session
gci -Hidden
```

## Run and RunOnce Registry Keys

Run and RunOnce registry keys are hives which contain logical group of keys, subkeys that support software and files loaded into memory when OS is started or user logs in. Useful for maintaining access to the system

The Windows registry includes the following four keys:
```powershell-session
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce
```

How to run Registry Keys #command 
```powershell-session
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run
```

## Application Whitelisting

- Whitelist is a list of approved software apps or executables allowed to be present and run on a system.
- Whitelist should be implemented in audit mode initially to make sure that all necessary applications are whitelisted and not blocked by an error of omission.
- Blacklisting specified list of harmful or disallowed software/apps to block.

Whitelisting is recommended by organisation such as NIST especially in high-security environments.

## App locker
App locker is Microsoft's application whitelisting solution and was first introduced in Windows 7. AppLocker controls applications and files users can run such as executables, scripts, Windows installer files, DLLs packed apps and packed app installers.

Settings can be adjusted by
- Publishers name
- Digital Signature
- Product name
- File name and version.
- Hashes and file paths.

## Local Group Policy
Group Policy allows administrators to set, configure and adjust a variety of settings. In a domain environment, group policies are pushed down from a domain controller onto all domain-joined machines that group policy objects (**GPOs**) are linked. These settings can also be defined on individual machines using local group policy.

- Group polices can be configured locally, in both domain and non domain environments.
- Can tweak graphical and network settings.
- Can lock down an individual computer policy with stringent security settings such as allowing certain programs to be installed.

Local Group Policy Editor #command 
```
gpedit.msc
```

The editor splits into *two* categories.
- User configuration
- Computer configuration
![[Pasted image 20240123234841.png]]

We can user Local Computer Policy to enable Credential Guard by enabling `Turn On Virtualization Based Security`. This protects against credential theft attacks.
![[Pasted image 20240123235045.png]]


## Windows Defender
Check Windows Defender protection #command 
```powershell-session
Get-MpComputerStatus | findstr "True"
```


# Skill Assessment
---

#HTB #windows 
Table of contents >>> [[Hack The Box]]
Previous Page >>> [[2.2 Windows Fundamentals - Interacting with Windows]]

## Windows Tasks
1. Creating a shared folder called Company Data
2. Creating a subfolder called HR inside of the Company Data folder
3. Creating a user called Jim
- `Uncheck: User must change password at logon`

4. 
5. Adding Jim to the HR security group
6. Adding the HR security group to the shared Company Data folder and NTFS permissions list
- `Remove the default group that is present`
- `Share Permissions: Allow Change & Read`
- `Disable Inheritance before issuing specific NTFS permissions`
- `NTFS permissions: Modify, Read & Execute, List folder contents, Read, Write`

7. Adding the HR security group to the NTFS permissions list of the HR subfolder
- `Remove the default group that is present`
- `Disable Inheritance before issuing specific NTFS permissions`
- `NTFS permissions: Modify, Read & Execute, List folder contents, Read, and Write`

8. Using PowerShell to list details about a service


## Solution
- Using properties on a folder we are using sharing and security tabs to finished the tasks
	- When assign user to a group etc remember to check names to create proper references
- Computer Management is better way of adding users and groups


To display services by their display name #command 
```
Get-Service -DisplayName 'DisplayName'
```


Get SID of users and groups #command 
```
Get-WmiObject Win32_UserAccount | Select-Object Name, SID
Get-WmiObject Win32_Group | Select-Object Name, SID
```

Help [Video](https://www.youtube.com/watch?v=cHCFAmGyL8Q&t=1473s)
